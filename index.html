<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizza Time Owner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
        }

        .hidden {
            display: none !important;
        }

        /* Login Screen */
        #loginScreen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: #ffffff;
        }

        #loginBox {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 400px;
        }

        #loginBox h2 {
            font-size: 24px;
            margin-bottom: 24px;
            color: #2c3e50;
        }

        #loginBox > div {
            margin-bottom: 16px;
        }

        #loginBox label {
            display: block;
            margin-bottom: 6px;
            color: #34495e;
            font-size: 14px;
            font-weight: 500;
        }

        #loginBox input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        #loginBox input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            padding: 12px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #2980b9;
        }

        .error {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 12px;
        }

        /* Main App */
        #mainApp {
            min-height: 100vh;
        }

        /* Navbar */
        .navbar {
            background: white;
            border-bottom: 1px solid #e8e8e8;
            padding: 0 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }

        .navbar-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 64px;
        }

        .navbar h1 {
            font-size: 20px;
            color: #2c3e50;
            font-weight: 600;
        }

        /* Main Menu */
        #mainMenu {
            max-width: 1200px;
            margin: 60px auto;
            padding: 0 24px;
        }

        #mainMenu h2 {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 32px;
            text-align: center;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            max-width: 800px;
            margin: 0 auto;
        }

        .menu-card {
            background: white;
            padding: 32px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .menu-card-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .menu-card h3 {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .menu-card p {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Tab Content */
        .tab-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .back-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 24px;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }

        .tab-header {
            margin-bottom: 32px;
        }

        .tab-header h2 {
            font-size: 24px;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .tab-header p {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* Filters/Controls */
        .filters {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
            min-width: 150px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 500;
            color: #34495e;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .filter-group select[multiple] {
            min-height: 100px;
        }

        /* Checkbox Group */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .checkbox-item:hover {
            background: #e9ecef;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3498db;
        }

        .checkbox-item span {
            font-size: 14px;
            color: #2c3e50;
            user-select: none;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .value {
            font-size: 28px;
            color: #2c3e50;
            font-weight: 600;
        }

        /* Màu sắc riêng cho từng loại doanh thu */
        .stat-cash {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #ffffff 0%, #f0fff4 100%);
        }

        .stat-cash .value {
            color: #27ae60;
        }

        .stat-transfer {
            border-left-color: #3498db;
            background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%);
        }

        .stat-transfer .value {
            color: #3498db;
        }

        .stat-grab {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
        }

        .stat-grab .value {
            color: #e74c3c;
        }

        .stat-shopee {
            border-left-color: #f39c12;
            background: linear-gradient(135deg, #ffffff 0%, #fffbeb 100%);
        }

        .stat-shopee .value {
            color: #f39c12;
        }

        /* Nổi bật Tổng Doanh Thu */
        .stat-total {
            border-left-color: #9b59b6;
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            box-shadow: 0 4px 16px rgba(155, 89, 182, 0.3);
            transform: scale(1.02);
        }

        .stat-total h3 {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
        }

        .stat-total .value {
            color: #ffffff;
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-total:hover {
            transform: scale(1.04);
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
        }

        /* Nổi bật Tổng Xuất Hàng */
        .stat-export-total {
            border-left-color: #e67e22;
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            box-shadow: 0 4px 16px rgba(230, 126, 34, 0.3);
            transform: scale(1.02);
        }

        .stat-export-total h3 {
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
        }

        .stat-export-total .value {
            color: #ffffff;
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-export-total:hover {
            transform: scale(1.04);
            box-shadow: 0 6px 20px rgba(230, 126, 34, 0.4);
        }

        /* Charts */
        .chart-wrapper,
        .chart-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .chart-card h3 {
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f8f9fa;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
        }

        th {
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            color: #34495e;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .menu-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen">
        <div id="loginBox">
            <h2>Đăng nhập - Pizza Time</h2>
            <div>
                <label>ID</label>
                <input id="userId" type="text" placeholder="owner or admin" />
            </div>
            <div>
                <label>Mật khẩu</label>
                <input id="userPassword" type="password" placeholder="password" />
            </div>
            <div style="display:flex; gap:8px; justify-content:flex-end;">
                <button onclick="login(event)" class="btn">Đăng nhập</button>
            </div>
            <div id="loginError" class="error" style="display:none;">Sai ID hoặc mật khẩu</div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="hidden">
        <!-- Navbar -->
        <nav class="navbar">
            <div class="navbar-content">
                <h1>🍕 Pizza Time Owner</h1>
                <button class="btn" onclick="logout()">Đăng xuất</button>
            </div>
        </nav>

        <!-- Main Menu -->
        <div id="mainMenu">
            <h2>Chọn chức năng</h2>
            <div class="menu-grid">
                <div class="menu-card" onclick="showTab('salesTab')">
                    <div class="menu-card-icon">💰</div>
                    <h3>Doanh thu</h3>
                    <p>Xem báo cáo doanh thu theo ngày và cửa hàng</p>
                </div>
                <div class="menu-card" onclick="showTab('quantityTab')">
                    <div class="menu-card-icon">📊</div>
                    <h3>Số lượng bán</h3>
                    <p>Phân tích số lượng bán theo loại sản phẩm</p>
                </div>
                <div class="menu-card" onclick="showTab('exportTab')">
                    <div class="menu-card-icon">📦</div>
                    <h3>Xuất hàng</h3>
                    <p>Quản lý và theo dõi xuất hàng cho các cửa hàng</p>
                </div>
            </div>
        </div>

        <!-- Sales Tab -->
        <div id="salesTab" class="hidden">
            <div class="tab-content">
                <button class="back-btn" onclick="showMainMenu()">← Quay lại</button>
                
                <div class="tab-header">
                    <h2>Báo cáo doanh thu</h2>
                    <p>Theo dõi doanh thu theo phương thức thanh toán và cửa hàng</p>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Loại thời gian</label>
                        <select id="dateTypeSale">
                            <option value="single">Ngày cố định</option>
                            <option value="range">Khoảng thời gian</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Từ ngày</label>
                        <input type="date" id="startDateSale">
                    </div>

                    <div class="filter-group" id="endDateGroupSale" style="display:none;">
                        <label>Đến ngày</label>
                        <input type="date" id="endDateSale">
                    </div>

                    <div class="filter-group">
                        <label>Chọn quán</label>
                        <div class="checkbox-group" id="storeCheckboxGroup">
                            <label class="checkbox-item">
                                <input type="checkbox" value="all" checked onchange="handleAllStoresCheckbox(this)">
                                <span>Tất cả các quán</span>
                            </label>
                        </div>
                    </div>

                    <div class="filter-group" style="align-self:flex-end;">
                        <button class="btn" onclick="fetchSaleData()">Xem báo cáo</button>
                    </div>
                </div>

                <div id="errorSale" class="error" style="display:none;"></div>
                <div id="loadingSale" class="loading" style="display:none;">Đang tải dữ liệu...</div>

                <div id="resultsSale" style="display:none;">
                    <div class="stats-grid">
                        <div class="stat-card stat-cash">
                            <h3>💵 Tiền Mặt</h3>
                            <div class="value" id="cashRevenue">0 đ</div>
                        </div>
                        <div class="stat-card stat-transfer">
                            <h3>💳 Chuyển Khoản</h3>
                            <div class="value" id="transferRevenue">0 đ</div>
                        </div>
                        <div class="stat-card stat-grab">
                            <h3>🛵 Grab</h3>
                            <div class="value" id="grabRevenue">0 đ</div>
                        </div>
                        <div class="stat-card stat-shopee">
                            <h3>🛒 Shopee</h3>
                            <div class="value" id="shopeeRevenue">0 đ</div>
                        </div>
                        <div class="stat-card stat-total">
                            <h3>💰 Tổng Doanh Thu</h3>
                            <div class="value" id="totalRevenue">0 đ</div>
                        </div>
                    </div>

                    <div class="charts-container">
                        <div class="chart-card">
                            <h3 id="chartTitle">Cơ Cấu Doanh Thu Theo Quán</h3>
                            <canvas id="revenueChart"></canvas>
                        </div>
                        <div class="chart-card" id="trendChartCard" style="display:none;">
                            <h3>Xu hướng doanh thu theo ngày</h3>
                            <canvas id="revenueTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quantity Tab -->
        <div id="quantityTab" class="hidden">
            <div class="tab-content">
                <button class="back-btn" onclick="showMainMenu()">← Quay lại</button>
                
                <div class="tab-header">
                    <h2>Số lượng bán theo loại</h2>
                    <p>Phân tích số lượng bán theo danh mục và cửa hàng</p>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Loại thời gian</label>
                        <select id="dateTypeQty">
                            <option value="single">Ngày cố định</option>
                            <option value="range">Khoảng thời gian</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Từ ngày</label>
                        <input type="date" id="startDateQty" />
                    </div>
                    <div class="filter-group" id="endDateGroupQty" style="display:none;">
                        <label>Đến ngày</label>
                        <input type="date" id="endDateQty" />
                    </div>
                    <div class="filter-group">
                        <label>Cửa hàng</label>
                        <select id="storeFilterQty">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <div class="filter-group" style="align-self:flex-end;">
                        <button class="btn" onclick="loadQuantityData()">Tải dữ liệu</button>
                    </div>
                </div>

                <div id="errorMessageQty" class="error" style="display:none;"></div>
                <div id="loadingMessageQty" class="loading" style="display:none;">Đang tải dữ liệu...</div>

                <div id="dashboardQty" style="display:none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Tổng số lượng</h3>
                            <div class="value" id="totalQuantity">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Số đơn hàng</h3>
                            <div class="value" id="totalOrders">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Danh mục</h3>
                            <div class="value" id="totalCategories">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>Sản phẩm</h3>
                            <div class="value" id="totalProducts">0</div>
                        </div>
                    </div>

                    <div class="chart-card" style="margin-bottom: 24px;">
                        <h3>🏆 Top 10 Sản Phẩm Bán Chạy Nhất</h3>
                        <canvas id="topProductsChart"></canvas>
                    </div>

                    <div class="charts-container">
                        <div class="chart-card">
                            <h3>Số lượng theo danh mục</h3>
                            <canvas id="categoryChart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>Số lượng theo cửa hàng</h3>
                            <canvas id="storeChart"></canvas>
                        </div>
                    </div>

                    <div class="chart-card">
                        <h3>Xu hướng theo ngày</h3>
                        <canvas id="dateChart"></canvas>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ngày</th>
                                    <th>Cửa hàng</th>
                                    <th>Danh mục</th>
                                    <th>Sản phẩm</th>
                                    <th>Số lượng</th>
                                    <th>Nhân viên</th>
                                </tr>
                            </thead>
                            <tbody id="dataTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="exportTab" class="hidden">
            <div class="tab-content">
                <button class="back-btn" onclick="showMainMenu()">← Quay lại</button>
                
                <div class="tab-header">
                    <h2>Xuất hàng</h2>
                    <p>Quản lý và theo dõi xuất hàng cho các cửa hàng</p>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label>Loại thời gian</label>
                        <select id="dateTypeExport">
                            <option value="single">Ngày cố định</option>
                            <option value="range">Khoảng thời gian</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Từ ngày</label>
                        <input type="date" id="startDateExport" />
                    </div>
                    <div class="filter-group" id="endDateGroupExport" style="display:none;">
                        <label>Đến ngày</label>
                        <input type="date" id="endDateExport" />
                    </div>
                    <div class="filter-group">
                        <label>Chọn quán</label>
                        <div class="checkbox-group" id="storeCheckboxGroupExport">
                            <label class="checkbox-item">
                                <input type="checkbox" value="all" checked onchange="handleAllStoresCheckboxExport(this)">
                                <span>Tất cả các quán</span>
                            </label>
                        </div>
                    </div>
                    <div class="filter-group" style="align-self:flex-end;">
                        <button class="btn" onclick="loadExportData()">Xem báo cáo</button>
                    </div>
                </div>

                <div id="errorExport" class="error" style="display:none;"></div>
                <div id="loadingExport" class="loading" style="display:none;">Đang tải dữ liệu...</div>

                <div id="resultsExport" style="display:none;">
                    <div class="stats-grid">
                        <div class="stat-card stat-export-total">
                            <h3>📦 Tổng số lượng xuất</h3>
                            <div class="value" id="totalExportQuantity">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>📋 Số lần xuất</h3>
                            <div class="value" id="totalExportOrders">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>🏪 Cửa hàng</h3>
                            <div class="value" id="totalExportStores">0</div>
                        </div>
                        <div class="stat-card">
                            <h3>📝 Sản phẩm</h3>
                            <div class="value" id="totalExportProducts">0</div>
                        </div>
                    </div>

                    <div class="chart-card" style="margin-bottom: 24px;">
                        <h3>🏆 Top 10 Sản Phẩm Xuất Nhiều Nhất</h3>
                        <canvas id="topExportProductsChart"></canvas>
                    </div>

                    <div class="charts-container">
                        <div class="chart-card">
                            <h3 id="exportChartTitle">Số lượng xuất theo cửa hàng</h3>
                            <canvas id="exportStoreChart"></canvas>
                        </div>
                        <div class="chart-card" id="exportTrendChartCard" style="display:none;">
                            <h3>Xu hướng xuất hàng theo ngày</h3>
                            <canvas id="exportTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Ngày</th>
                                    <th>Cửa hàng</th>
                                    <th>Sản phẩm</th>
                                    <th>Số lượng</th>
                                    <th>Ghi chú</th>
                                </tr>
                            </thead>
                            <tbody id="exportDataTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        /****************** CONFIG ******************/
        const SUPABASE_URL = 'https://tyuufjwutazjfuiawiul.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR5dXVmand1dGF6amZ1aWF3aXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MDk4OTIsImV4cCI6MjA3NjA4NTg5Mn0.8WEsb2tBD6akNA9h9tR9zIAqjkZz0xZYVNbYCx2dEbc';
        /*******************************************/

        const validUsers = {
            'Bo@Phuc': 'Nhim=Khanh',
            'Nhim@Khanh': 'Bo=Phuc'
        };

        // Navigation Functions
        function showMainMenu() {
            document.getElementById('mainMenu').classList.remove('hidden');
            document.getElementById('salesTab').classList.add('hidden');
            document.getElementById('quantityTab').classList.add('hidden');
            document.getElementById('exportTab').classList.add('hidden');
        }

        function showTab(tabId) {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('salesTab').classList.add('hidden');
            document.getElementById('quantityTab').classList.add('hidden');
            document.getElementById('exportTab').classList.add('hidden');
            document.getElementById(tabId).classList.remove('hidden');
        }

        // Auth Functions
        function login(event) {
            event.preventDefault();
            const userId = document.getElementById('userId').value;
            const password = document.getElementById('userPassword').value;

            if (validUsers[userId] && validUsers[userId] === password) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('loginError').style.display = 'none';
                initUIAfterLogin();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('userId').value = '';
            document.getElementById('userPassword').value = '';
            showMainMenu();
        }

        // Utilities
        function formatMoney(amount) {
            if (isNaN(amount)) amount = 0;
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function showElement(id, show = true) {
            const el = document.getElementById(id);
            if (!el) return;
            el.style.display = show ? 'block' : 'none';
        }

        function setText(id, text) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = text;
        }

        function getNumberField(item, candidates = []) {
            for (const name of candidates) {
                if (item.hasOwnProperty(name) && item[name] !== null && item[name] !== undefined && item[name] !== '') {
                    const n = parseFloat(item[name]);
                    if (!isNaN(n)) return n;
                }
            }
            return 0;
        }

        // UI Initialization
        function initUIAfterLogin() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDateSale').value = today;
            document.getElementById('endDateSale').value = today;
            document.getElementById('startDateQty').value = today;
            document.getElementById('endDateQty').value = today;

            document.getElementById('dateTypeSale').addEventListener('change', function () {
                document.getElementById('endDateGroupSale').style.display = this.value === 'range' ? 'flex' : 'none';
            });

            document.getElementById('dateTypeQty').addEventListener('change', function () {
                document.getElementById('endDateGroupQty').style.display = this.value === 'range' ? 'flex' : 'none';
            });

            document.getElementById('dateTypeExport').addEventListener('change', function () {
                document.getElementById('endDateGroupExport').style.display = this.value === 'range' ? 'flex' : 'none';
            });

            // Initialize store checkboxes for sales
            const storesDefault = ['DH', 'NH', 'HXH', 'PY'];
            document.getElementById('startDateExport').value = today;
            document.getElementById('endDateExport').value = today;
            const checkboxGroup = document.getElementById('storeCheckboxGroup');
            
            storesDefault.forEach(s => {
                const label = document.createElement('label');
                label.className = 'checkbox-item';
                label.innerHTML = `
                    <input type="checkbox" value="${s}" onchange="handleStoreCheckbox()">
                    <span>${s}</span>
                `;
                checkboxGroup.appendChild(label);
            });

            // Initialize store checkboxes for export
            const checkboxGroupExport = document.getElementById('storeCheckboxGroupExport');
            storesDefault.forEach(s => {
                const label = document.createElement('label');
                label.className = 'checkbox-item';
                label.innerHTML = `
                    <input type="checkbox" value="${s}" onchange="handleStoreCheckboxExport()">
                    <span>${s}</span>
                `;
                checkboxGroupExport.appendChild(label);
            });

            // Initialize store select for quantity
            const sQty = document.getElementById('storeFilterQty');
            sQty.innerHTML = '<option value="">Tất cả</option>';
            storesDefault.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                sQty.appendChild(opt);
            });

            if (SUPABASE_URL && SUPABASE_KEY) {
                fetchStoresForQty();
            }
        }

        // Handle "All stores" checkbox
        function handleAllStoresCheckbox(checkbox) {
            const checkboxes = document.querySelectorAll('#storeCheckboxGroup input[type="checkbox"]:not([value="all"])');
            if (checkbox.checked) {
                checkboxes.forEach(cb => cb.checked = false);
            }
        }

        // Handle individual store checkboxes
        function handleStoreCheckbox() {
            const allCheckbox = document.querySelector('#storeCheckboxGroup input[value="all"]');
            const storeCheckboxes = document.querySelectorAll('#storeCheckboxGroup input[type="checkbox"]:not([value="all"])');
            const anyChecked = Array.from(storeCheckboxes).some(cb => cb.checked);
            
            if (anyChecked) {
                allCheckbox.checked = false;
            } else {
                allCheckbox.checked = true;
            }
        }

        // Get selected stores from checkboxes
        function getSelectedStores() {
            const allCheckbox = document.querySelector('#storeCheckboxGroup input[value="all"]');
            if (allCheckbox.checked) {
                return ['all'];
            }
            
            const storeCheckboxes = document.querySelectorAll('#storeCheckboxGroup input[type="checkbox"]:not([value="all"]):checked');
            return Array.from(storeCheckboxes).map(cb => cb.value);
        }

        // Export tab checkbox handlers
        function handleAllStoresCheckboxExport(checkbox) {
            const checkboxes = document.querySelectorAll('#storeCheckboxGroupExport input[type="checkbox"]:not([value="all"])');
            if (checkbox.checked) {
                checkboxes.forEach(cb => cb.checked = false);
            }
        }

        function handleStoreCheckboxExport() {
            const allCheckbox = document.querySelector('#storeCheckboxGroupExport input[value="all"]');
            const storeCheckboxes = document.querySelectorAll('#storeCheckboxGroupExport input[type="checkbox"]:not([value="all"])');
            const anyChecked = Array.from(storeCheckboxes).some(cb => cb.checked);
            
            if (anyChecked) {
                allCheckbox.checked = false;
            } else {
                allCheckbox.checked = true;
            }
        }

        function getSelectedStoresExport() {
            const allCheckbox = document.querySelector('#storeCheckboxGroupExport input[value="all"]');
            if (allCheckbox.checked) {
                return ['all'];
            }
            
            const storeCheckboxes = document.querySelectorAll('#storeCheckboxGroupExport input[type="checkbox"]:not([value="all"]):checked');
            return Array.from(storeCheckboxes).map(cb => cb.value);
        }

        // Sales Logic
        let saleChart = null;
        let revenueTrendChart = null;

        async function fetchSaleData() {
            const start = document.getElementById('startDateSale').value;
            const type = document.getElementById('dateTypeSale').value;
            const end = (type === 'range') ? document.getElementById('endDateSale').value : start;
            const selected = getSelectedStores();

            if (!start) {
                setText('errorSale', 'Vui lòng chọn ngày');
                showElement('errorSale', true);
                return;
            }
            
            if (selected.length === 0) {
                setText('errorSale', 'Vui lòng chọn ít nhất một quán');
                showElement('errorSale', true);
                return;
            }
            
            showElement('errorSale', false);
            setText('loadingSale', 'Đang tải dữ liệu...');
            showElement('loadingSale', true);
            showElement('resultsSale', false);

            try {
                if (!SUPABASE_URL || !SUPABASE_KEY) {
                    await new Promise(r => setTimeout(r, 600));
                    const sampleTotals = { cash: 15000000, transfer: 8500000, grab: 3200000, shopee: 2100000, total: 28800000 };
                    displaySaleTotals(sampleTotals, false);
                    return;
                }

                let url = `${SUPABASE_URL}/rest/v1/sale_quan?date=gte.${start}&date=lte.${end}&select=*`;
                if (!selected.includes('all') && selected.length > 0) {
                    const orParts = selected.map(s => `store_id.eq.${encodeURIComponent(s)}`);
                    url += `&or=(${orParts.join(',')})`;
                }

                const res = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (!data || data.length === 0) {
                    setText('errorSale', 'Không có dữ liệu trong khoảng thời gian này');
                    showElement('errorSale', true);
                    showElement('loadingSale', false);
                    return;
                }

                const totals = data.reduce((acc, item) => {
                    acc.cash += getNumberField(item, ['cash_revenue', 'cash', 'cash_amount']);
                    acc.transfer += getNumberField(item, ['transfer_revenue', 'momo', 'transfer']);
                    acc.grab += getNumberField(item, ['grab_revenue', 'grab']);
                    acc.shopee += getNumberField(item, ['shopee_revenue', 'shopee']);
                    acc.total += getNumberField(item, ['total_revenue', 'total', 'total_amount']);
                    return acc;
                }, { cash: 0, transfer: 0, grab: 0, shopee: 0, total: 0 });

                displaySaleTotals(totals, true, data);

            } catch (err) {
                setText('errorSale', 'Lỗi khi lấy dữ liệu: ' + err.message);
                showElement('errorSale', true);
            } finally {
                showElement('loadingSale', false);
            }
        }

        function displaySaleTotals(totals, fromServer = false, rows = []) {
            setText('cashRevenue', formatMoney(totals.cash));
            setText('transferRevenue', formatMoney(totals.transfer));
            setText('grabRevenue', formatMoney(totals.grab));
            setText('shopeeRevenue', formatMoney(totals.shopee));
            setText('totalRevenue', formatMoney(totals.total));

            const selected = getSelectedStores();
            const isSingleStore = (!selected.includes('all') && selected.length === 1);
            const type = document.getElementById('dateTypeSale').value;
            const isRangeMode = (type === 'range');

            if (isSingleStore) {
                document.getElementById('chartTitle').textContent = 'Cơ Cấu Doanh Thu Theo Phương Thức';
                drawPaymentMethodChart(totals);
                
                // Show trend chart for single store in range mode
                if (isRangeMode && fromServer && rows && rows.length) {
                    showElement('trendChartCard', true);
                    drawRevenueTrendChartSingleStore(rows);
                } else {
                    showElement('trendChartCard', false);
                }
            } else {
                document.getElementById('chartTitle').textContent = 'Cơ Cấu Doanh Thu Theo Quán';
                if (fromServer && rows && rows.length) {
                    const byStore = {};
                    rows.forEach(r => {
                        const storeId = r.store_id || r.store || 'Unknown';
                        // Chỉ tính các quán có trong danh sách (bỏ qua admin, unknown...)
                        const validStores = ['DH', 'NH', 'HXH', 'PY'];
                        if (validStores.includes(storeId)) {
                            byStore[storeId] = (byStore[storeId] || 0) + getNumberField(r, ['total_revenue', 'total', 'total_amount']);
                        }
                    });
                    drawStoreChart(byStore);
                    
                    // Show trend chart for multiple stores in range mode
                    if (isRangeMode) {
                        showElement('trendChartCard', true);
                        drawRevenueTrendChartMultiStore(rows);
                    } else {
                        showElement('trendChartCard', false);
                    }
                } else {
                    drawStoreChart({ 'DH': totals.total * 0.4, 'NH': totals.total * 0.3, 'HXH': totals.total * 0.2, 'PY': totals.total * 0.1 });
                    showElement('trendChartCard', false);
                }
            }

            showElement('resultsSale', true);
        }

        function drawPaymentMethodChart(totals) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            if (saleChart) saleChart.destroy();

            saleChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Tiền Mặt', 'Chuyển Khoản', 'Grab', 'Shopee'],
                    datasets: [{
                        data: [totals.cash, totals.transfer, totals.grab, totals.shopee],
                        backgroundColor: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
        }

        function drawRevenueTrendChartSingleStore(rows) {
            const ctx = document.getElementById('revenueTrendChart').getContext('2d');
            if (revenueTrendChart) revenueTrendChart.destroy();

            // Group by date
            const byDate = {};
            rows.forEach(r => {
                const date = r.date;
                if (!byDate[date]) {
                    byDate[date] = 0;
                }
                byDate[date] += getNumberField(r, ['total_revenue', 'total', 'total_amount']);
            });

            const sortedDates = Object.keys(byDate).sort();
            const values = sortedDates.map(d => byDate[d]);

            revenueTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Doanh thu',
                        data: values,
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderColor: '#3498db',
                        pointBackgroundColor: '#3498db',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Doanh thu: ' + formatMoney(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value / 1000000).toFixed(0) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawRevenueTrendChartMultiStore(rows) {
            const ctx = document.getElementById('revenueTrendChart').getContext('2d');
            if (revenueTrendChart) revenueTrendChart.destroy();

            const selected = getSelectedStores();
            const isAllStores = selected.includes('all');

            if (isAllStores) {
                // Chọn "Tất cả" → Hiển thị 1 line chart tổng
                const byDate = {};
                rows.forEach(r => {
                    const date = r.date;
                    if (!byDate[date]) {
                        byDate[date] = 0;
                    }
                    byDate[date] += getNumberField(r, ['total_revenue', 'total', 'total_amount']);
                });

                const sortedDates = Object.keys(byDate).sort();
                const values = sortedDates.map(d => byDate[d]);

                revenueTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'Tổng doanh thu',
                            data: values,
                            tension: 0.3,
                            fill: true,
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderColor: '#3498db',
                            pointBackgroundColor: '#3498db',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Tổng doanh thu: ' + formatMoney(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return (value / 1000000).toFixed(0) + 'M';
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // Chọn cụ thể → Hiển thị line chart của TỪNG quán được chọn
                const byDateStore = {};
                
                rows.forEach(r => {
                    const date = r.date;
                    const storeId = r.store_id || r.store || 'Unknown';
                    
                    // Chỉ xử lý các quán được chọn
                    if (!selected.includes(storeId)) return;

                    if (!byDateStore[date]) {
                        byDateStore[date] = {};
                    }
                    if (!byDateStore[date][storeId]) {
                        byDateStore[date][storeId] = 0;
                    }
                    byDateStore[date][storeId] += getNumberField(r, ['total_revenue', 'total', 'total_amount']);
                });

                const sortedDates = Object.keys(byDateStore).sort();
                const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c'];

                const datasets = selected.map((storeId, index) => {
                    return {
                        label: storeId,
                        data: sortedDates.map(date => byDateStore[date] && byDateStore[date][storeId] ? byDateStore[date][storeId] : 0),
                        tension: 0.3,
                        fill: false,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length],
                        pointBackgroundColor: colors[index % colors.length],
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    };
                });

                revenueTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + formatMoney(context.parsed.y);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return (value / 1000000).toFixed(0) + 'M';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function drawStoreChart(storeRevenue) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            if (saleChart) saleChart.destroy();

            const selected = getSelectedStores();
            const isAllStores = selected.includes('all');

            let labels, data;

            if (isAllStores) {
                // Chọn "Tất cả" → Hiển thị tất cả các quán có dữ liệu
                labels = Object.keys(storeRevenue);
                data = Object.values(storeRevenue);
            } else {
                // Chọn cụ thể → Chỉ hiển thị các quán được chọn
                labels = [];
                data = [];
                selected.forEach(storeId => {
                    if (storeRevenue[storeId]) {
                        labels.push(storeId);
                        data.push(storeRevenue[storeId]);
                    }
                });
            }

            saleChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = formatMoney(context.parsed);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Quantity Logic
        let categoryChart = null, storeChart = null, dateChart = null, topProductsChart = null;

        async function loadQuantityData() {
            const start = document.getElementById('startDateQty').value;
            const type = document.getElementById('dateTypeQty').value;
            const end = (type === 'range') ? document.getElementById('endDateQty').value : start;
            const store = document.getElementById('storeFilterQty').value;

            if (!start) {
                setText('errorMessageQty', 'Vui lòng chọn ngày');
                showElement('errorMessageQty', true);
                return;
            }
            showElement('errorMessageQty', false);
            setText('loadingMessageQty', 'Đang tải dữ liệu...');
            showElement('loadingMessageQty', true);
            showElement('dashboardQty', false);

            try {
                if (!SUPABASE_URL || !SUPABASE_KEY) {
                    await new Promise(r => setTimeout(r, 600));
                    const sample = [
                        { date: start, store: 'DH', category: 'Pizza Truyền thống', product_name: 'Gà teriyaki', quantity: 2, employee: 'Yen' },
                        { date: start, store: 'NH', category: 'Pizza Gà', product_name: 'Gà nướng', quantity: 3, employee: 'Le' },
                        { date: end, store: 'HXH', category: 'Pizza Truyền thống', product_name: 'Pepperoni', quantity: 4, employee: 'Xuan' }
                    ];
                    processQuantityData(sample);
                    return;
                }

                let url = `${SUPABASE_URL}/rest/v1/pizza_sales?date=gte.${start}&date=lte.${end}&select=*`;
                if (store) url += `&store=eq.${encodeURIComponent(store)}`;

                const res = await fetch(url, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (!res.ok) throw new Error('Không thể tải dữ liệu');
                const data = await res.json();

                if (!data || data.length === 0) {
                    setText('errorMessageQty', 'Không có dữ liệu');
                    showElement('errorMessageQty', true);
                    showElement('loadingMessageQty', false);
                    return;
                }

                processQuantityData(data);

            } catch (err) {
                setText('errorMessageQty', 'Lỗi: ' + err.message);
                showElement('errorMessageQty', true);
            } finally {
                showElement('loadingMessageQty', false);
            }
        }

        function processQuantityData(data) {
            const totalQuantity = data.reduce((s, it) => s + (parseInt(it.quantity) || 0), 0);
            const totalOrders = data.length;
            const categories = new Set(data.map(it => it.category || 'Khác'));
            const products = new Set(data.map(it => it.product_name || it.product || 'Unknown'));

            setText('totalQuantity', totalQuantity.toLocaleString());
            setText('totalOrders', totalOrders.toLocaleString());
            setText('totalCategories', categories.size);
            setText('totalProducts', products.size);

            const categoryData = {};
            const storeData = {};
            const dateData = {};
            const productData = {};

            data.forEach(it => {
                const qty = parseInt(it.quantity) || 0;
                const productName = it.product_name || it.product || 'Unknown';
                
                categoryData[it.category] = (categoryData[it.category] || 0) + qty;
                storeData[it.store] = (storeData[it.store] || 0) + qty;
                dateData[it.date] = (dateData[it.date] || 0) + qty;
                productData[productName] = (productData[productName] || 0) + qty;
            });

            createTopProductsChart(productData);
            createQuantityCharts(categoryData, storeData, dateData);
            createQuantityTable(data);

            showElement('dashboardQty', true);
        }

        function createTopProductsChart(productData) {
            if (topProductsChart) topProductsChart.destroy();

            // Sắp xếp sản phẩm theo số lượng giảm dần và lấy top 10
            const sortedProducts = Object.entries(productData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const labels = sortedProducts.map(item => item[0]);
            const data = sortedProducts.map(item => item[1]);

            // Tạo màu gradient cho các cột
            const colors = data.map((value, index) => {
                const hue = 120 - (index * 12); // Từ xanh lá sang vàng cam
                return `hsl(${hue}, 70%, 55%)`;
            });

            const ctx = document.getElementById('topProductsChart').getContext('2d');
            topProductsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số lượng bán',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('55%', '45%')),
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Số lượng: ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function createQuantityCharts(categoryData, storeData, dateData) {
                if (categoryChart) categoryChart.destroy();
                if (storeChart) storeChart.destroy();
                if (dateChart) dateChart.destroy();

                const catCtx = document.getElementById('categoryChart').getContext('2d');
                categoryChart = new Chart(catCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categoryData),
                        datasets: [{
                            data: Object.values(categoryData),
                            backgroundColor: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });

                const stCtx = document.getElementById('storeChart').getContext('2d');
                storeChart = new Chart(stCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(storeData),
                        datasets: [{
                            label: 'Số lượng',
                            data: Object.values(storeData),
                            backgroundColor: '#3498db'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });

                const sortedDates = Object.keys(dateData).sort();
                const dtCtx = document.getElementById('dateChart').getContext('2d');
                dateChart = new Chart(dtCtx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'Số lượng bán',
                            data: sortedDates.map(d => dateData[d]),
                            tension: 0.3,
                            fill: true,
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderColor: '#3498db'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            function createQuantityTable(data) {
        const tbody = document.getElementById('dataTable');
        tbody.innerHTML = '';
        
        const type = document.getElementById('dateTypeQty').value;
        const isRangeMode = (type === 'range');
        const storeFilter = document.getElementById('storeFilterQty').value;
        const isAllStores = !storeFilter; // Kiểm tra xem có chọn "Tất cả" không

        if (isRangeMode) {
            // Khi chọn dải ngày: Gộp theo product_name (và store nếu không phải "Tất cả")
            const aggregated = {};
            
            data.forEach(it => {
                const productName = it.product_name || it.product || 'Unknown';
                let key;
                
                if (isAllStores) {
                    // Nếu chọn "Tất cả các quán" -> gộp theo product_name + category
                    key = `${it.category}|${productName}`;
                } else {
                    // Nếu chọn quán cụ thể -> gộp theo store + category + product_name
                    key = `${it.store}|${it.category}|${productName}`;
                }
                
                const qty = parseInt(it.quantity) || 0;
                
                if (!aggregated[key]) {
                    aggregated[key] = {
                        store: isAllStores ? 'Tất cả các quán' : it.store,
                        category: it.category,
                        product_name: productName,
                        quantity: 0
                    };
                }
                aggregated[key].quantity += qty;
            });

            // Chuyển thành mảng và sắp xếp
            const aggregatedArray = Object.values(aggregated);
            
            if (isAllStores) {
                // Sắp xếp theo số lượng giảm dần khi chọn "Tất cả"
                aggregatedArray.sort((a, b) => b.quantity - a.quantity);
            } else {
                // Sắp xếp theo cửa hàng, sau đó theo số lượng giảm dần
                aggregatedArray.sort((a, b) => {
                    if (a.store !== b.store) {
                        return a.store.localeCompare(b.store);
                    }
                    return b.quantity - a.quantity;
                });
            }

            // Hiển thị bảng với cột phù hợp
            aggregatedArray.forEach(it => {
                const row = document.createElement('tr');
                
                if (isAllStores) {
                    // Không hiển thị cột "Cửa hàng" khi chọn "Tất cả"
                    row.innerHTML = `
                        <td>${it.category || ''}</td>
                        <td>${it.product_name || ''}</td>
                        <td><strong>${it.quantity.toLocaleString()}</strong></td>
                    `;
                } else {
                    // Hiển thị đầy đủ khi chọn quán cụ thể
                    row.innerHTML = `
                        <td>${it.store || ''}</td>
                        <td>${it.category || ''}</td>
                        <td>${it.product_name || ''}</td>
                        <td><strong>${it.quantity.toLocaleString()}</strong></td>
                    `;
                }
                
                tbody.appendChild(row);
            });
        } else {
            // Khi chọn ngày cố định: Hiển thị từng dòng với đầy đủ thông tin
            data.sort((a, b) => new Date(b.date) - new Date(a.date));
            data.forEach(it => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${it.date}</td>
                    <td>${it.store || ''}</td>
                    <td>${it.category || ''}</td>
                    <td>${it.product_name || it.product || ''}</td>
                    <td><strong>${it.quantity || 0}</strong></td>
                    <td>${it.employee || ''}</td>
                `;
                tbody.appendChild(row);
            });
        }
    }

        async function fetchStoresForQty() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/sale_quan?select=store_id,username`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (!res.ok) return;
                const data = await res.json();
                const stores = [...new Map((data || []).map(i => [i.store_id, i])).values()];
                const select = document.getElementById('storeFilterQty');
                select.innerHTML = '<option value="">Tất cả</option>';
                stores.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s.store_id;
                    option.textContent = s.username ? `${s.username} (${s.store_id})` : s.store_id;
                    select.appendChild(option);
                });
            } catch (err) {
                console.warn('Không tải được danh sách quán:', err.message);
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            if (!document.getElementById('startDateSale').value) document.getElementById('startDateSale').value = today;
            if (!document.getElementById('endDateSale').value) document.getElementById('endDateSale').value = today;
            if (!document.getElementById('startDateQty').value) document.getElementById('startDateQty').value = today;
            if (!document.getElementById('endDateQty').value) document.getElementById('endDateQty').value = today;
        });

       // Export Logic
        let exportStoreChart = null, exportTrendChart = null, topExportProductsChart = null;

        async function loadExportData() {
            const start = document.getElementById('startDateExport').value;
            const type = document.getElementById('dateTypeExport').value;
            const end = (type === 'range') ? document.getElementById('endDateExport').value : start;
            const selected = getSelectedStoresExport();

            if (!start) {
                setText('errorExport', 'Vui lòng chọn ngày');
                showElement('errorExport', true);
                return;
            }
            
            if (selected.length === 0) {
                setText('errorExport', 'Vui lòng chọn ít nhất một quán');
                showElement('errorExport', true);
                return;
            }
            
            showElement('errorExport', false);
            setText('loadingExport', 'Đang tải dữ liệu...');
            showElement('loadingExport', true);
            showElement('resultsExport', false);

            try {
                if (!SUPABASE_URL || !SUPABASE_KEY) {
                    await new Promise(r => setTimeout(r, 600));
                    const sampleData = [
                        { date: start, store: 'DH', item: 'Mực (bịch)', quantity: -500, created_at: '2025-10-21T11:35:21.719641+00' },
                        { date: start, store: 'NH', item: 'Gà Lắc (bịch)', quantity: -300, created_at: '2025-10-21T11:35:21.342029+00' }
                    ];
                    processExportData(sampleData);
                    return;
                }

                let url = `${SUPABASE_URL}/rest/v1/exports?date=gte.${start}&date=lte.${end}&select=*&order=created_at.desc`;
                if (!selected.includes('all') && selected.length > 0) {
                    const orParts = selected.map(s => `store.eq.${encodeURIComponent(s)}`);
                    url += `&or=(${orParts.join(',')})`;
                }

                const res = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                if (!data || data.length === 0) {
                    setText('errorExport', 'Không có dữ liệu trong khoảng thời gian này');
                    showElement('errorExport', true);
                    showElement('loadingExport', false);
                    return;
                }

                processExportData(data);

            } catch (err) {
                setText('errorExport', 'Lỗi khi lấy dữ liệu: ' + err.message);
                showElement('errorExport', true);
            } finally {
                showElement('loadingExport', false);
            }
        }

        function processExportData(rawData) {
            // Group by date + store + item, keep only latest created_at
            const grouped = {};
            rawData.forEach(item => {
                const key = `${item.date}|${item.store}|${item.item}`;
                if (!grouped[key] || new Date(item.created_at) > new Date(grouped[key].created_at)) {
                    grouped[key] = item;
                }
            });

            const data = Object.values(grouped);

            // Calculate totals
            const totalQuantity = data.reduce((sum, item) => sum + Math.abs(parseFloat(item.quantity) || 0), 0);
            const totalOrders = data.length;
            const stores = new Set(data.map(item => item.store));
            const products = new Set(data.map(item => item.item));

            setText('totalExportQuantity', totalQuantity.toLocaleString());
            setText('totalExportOrders', totalOrders.toLocaleString());
            setText('totalExportStores', stores.size);
            setText('totalExportProducts', products.size);

            // Aggregate data for charts
            const byStore = {};
            const byDate = {};
            const byProduct = {};

            data.forEach(item => {
                const qty = Math.abs(parseFloat(item.quantity) || 0);
                
                byStore[item.store] = (byStore[item.store] || 0) + qty;
                byDate[item.date] = (byDate[item.date] || 0) + qty;
                byProduct[item.item] = (byProduct[item.item] || 0) + qty;
            });

            // Display charts
            const selected = getSelectedStoresExport();
            const isSingleStore = (!selected.includes('all') && selected.length === 1);
            const type = document.getElementById('dateTypeExport').value;
            const isRangeMode = (type === 'range');

            if (isSingleStore) {
                document.getElementById('exportChartTitle').textContent = 'Top 10 sản phẩm xuất nhiều nhất';
                drawTopExportProductsChartSingle(byProduct);
                
                if (isRangeMode) {
                    showElement('exportTrendChartCard', true);
                    drawExportTrendChartSingle(data);
                } else {
                    showElement('exportTrendChartCard', false);
                }
            } else {
                document.getElementById('exportChartTitle').textContent = 'Số lượng xuất theo cửa hàng';
                drawExportStoreChart(byStore, selected);
                
                if (isRangeMode) {
                    showElement('exportTrendChartCard', true);
                    drawExportTrendChartMulti(data, selected);
                } else {
                    showElement('exportTrendChartCard', false);
                }
            }

            // Draw top products chart (always show)
            drawTopExportProductsChart(byProduct);

            // Create table
            createExportTable(data);

            showElement('resultsExport', true);
        }

        function drawTopExportProductsChart(productData) {
            if (topExportProductsChart) topExportProductsChart.destroy();

            // Sort and get top 10
            const sortedProducts = Object.entries(productData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const labels = sortedProducts.map(item => item[0]);
            const data = sortedProducts.map(item => item[1]);

            const colors = data.map((value, index) => {
                const hue = 200 - (index * 15);
                return `hsl(${hue}, 65%, 55%)`;
            });

            const ctx = document.getElementById('topExportProductsChart').getContext('2d');
            topExportProductsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số lượng xuất',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('55%', '45%')),
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Số lượng: ' + context.parsed.x.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function drawTopExportProductsChartSingle(productData) {
            const ctx = document.getElementById('exportStoreChart').getContext('2d');
            if (exportStoreChart) exportStoreChart.destroy();

            const sortedProducts = Object.entries(productData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const labels = sortedProducts.map(item => item[0]);
            const data = sortedProducts.map(item => item[1]);

            const colors = data.map((value, index) => {
                const hue = 200 - (index * 15);
                return `hsl(${hue}, 65%, 55%)`;
            });

            exportStoreChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Số lượng xuất',
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color.replace('55%', '45%')),
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Số lượng: ' + context.parsed.x.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawExportStoreChart(storeData, selected) {
            const ctx = document.getElementById('exportStoreChart').getContext('2d');
            if (exportStoreChart) exportStoreChart.destroy();

            const isAllStores = selected.includes('all');
            let labels, data;

            if (isAllStores) {
                labels = Object.keys(storeData);
                data = Object.values(storeData);
            } else {
                labels = [];
                data = [];
                selected.forEach(storeId => {
                    if (storeData[storeId]) {
                        labels.push(storeId);
                        data.push(storeData[storeId]);
                    }
                });
            }

            exportStoreChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data,
                        backgroundColor: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed.toLocaleString();
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawExportTrendChartSingle(data) {
            const ctx = document.getElementById('exportTrendChart').getContext('2d');
            if (exportTrendChart) exportTrendChart.destroy();

            const byDate = {};
            data.forEach(item => {
                const date = item.date;
                const qty = Math.abs(parseFloat(item.quantity) || 0);
                byDate[date] = (byDate[date] || 0) + qty;
            });

            const sortedDates = Object.keys(byDate).sort();
            const values = sortedDates.map(d => byDate[d]);

            exportTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'Số lượng xuất',
                        data: values,
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(230, 126, 34, 0.1)',
                        borderColor: '#e67e22',
                        pointBackgroundColor: '#e67e22',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Số lượng: ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawExportTrendChartMulti(data, selected) {
            const ctx = document.getElementById('exportTrendChart').getContext('2d');
            if (exportTrendChart) exportTrendChart.destroy();

            const isAllStores = selected.includes('all');

            if (isAllStores) {
                const byDate = {};
                data.forEach(item => {
                    const date = item.date;
                    const qty = Math.abs(parseFloat(item.quantity) || 0);
                    byDate[date] = (byDate[date] || 0) + qty;
                });

                const sortedDates = Object.keys(byDate).sort();
                const values = sortedDates.map(d => byDate[d]);

                exportTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'Tổng số lượng xuất',
                            data: values,
                            tension: 0.3,
                            fill: true,
                            backgroundColor: 'rgba(230, 126, 34, 0.1)',
                            borderColor: '#e67e22',
                            pointBackgroundColor: '#e67e22',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return 'Tổng số lượng: ' + context.parsed.y.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                const byDateStore = {};
                
                data.forEach(item => {
                    const date = item.date;
                    const storeId = item.store;
                    const qty = Math.abs(parseFloat(item.quantity) || 0);
                    
                    if (!selected.includes(storeId)) return;

                    if (!byDateStore[date]) {
                        byDateStore[date] = {};
                    }
                    if (!byDateStore[date][storeId]) {
                        byDateStore[date][storeId] = 0;
                    }
                    byDateStore[date][storeId] += qty;
                });

                const sortedDates = Object.keys(byDateStore).sort();
                const colors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6', '#1abc9c'];

                const datasets = selected.map((storeId, index) => {
                    return {
                        label: storeId,
                        data: sortedDates.map(date => byDateStore[date] && byDateStore[date][storeId] ? byDateStore[date][storeId] : 0),
                        tension: 0.3,
                        fill: false,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length],
                        pointBackgroundColor: colors[index % colors.length],
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4
                    };
                });

                exportTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString();
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function createExportTable(data) {
            const tbody = document.getElementById('exportDataTable');
            tbody.innerHTML = '';
            
            const type = document.getElementById('dateTypeExport').value;
            const isRangeMode = (type === 'range');

            if (isRangeMode) {
                // Khi chọn dải ngày: Gộp theo store + item
                const aggregated = {};
                
                data.forEach(item => {
                    const key = `${item.store}|${item.item}`;
                    const qty = Math.abs(parseFloat(item.quantity) || 0);
                    
                    if (!aggregated[key]) {
                        aggregated[key] = {
                            store: item.store,
                            item: item.item,
                            quantity: 0,
                            user_name: item.user_name
                        };
                    }
                    aggregated[key].quantity += qty;
                });

                // Chuyển thành mảng và sắp xếp theo số lượng giảm dần
                const aggregatedArray = Object.values(aggregated);
                aggregatedArray.sort((a, b) => b.quantity - a.quantity);

                aggregatedArray.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="1"><em>Tổng</em></td>
                        <td>${item.store || ''}</td>
                        <td>${item.item || ''}</td>
                        <td><strong>${item.quantity.toLocaleString()}</strong></td>
                        <td>${item.user_name || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                // Khi chọn ngày cố định: Hiển thị từng dòng như cũ
                data.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                data.forEach(item => {
                    const row = document.createElement('tr');
                    const qty = Math.abs(parseFloat(item.quantity) || 0);
                    row.innerHTML = `
                        <td>${item.date}</td>
                        <td>${item.store || ''}</td>
                        <td>${item.item || ''}</td>
                        <td><strong>${qty.toLocaleString()}</strong></td>
                        <td>${item.user_name || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            if (!document.getElementById('startDateSale').value) document.getElementById('startDateSale').value = today;
            if (!document.getElementById('endDateSale').value) document.getElementById('endDateSale').value = today;
            if (!document.getElementById('startDateQty').value) document.getElementById('startDateQty').value = today;
            if (!document.getElementById('endDateQty').value) document.getElementById('endDateQty').value = today;
            if (!document.getElementById('startDateExport').value) document.getElementById('startDateExport').value = today;
            if (!document.getElementById('endDateExport').value) document.getElementById('endDateExport').value = today;
        });
    </script>
</body>
</html>
